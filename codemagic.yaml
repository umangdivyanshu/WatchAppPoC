# Automatically generated on 2021-08-18 UTC from https://codemagic.io/app/610abffa53f857ec1926e769/settings
# Note that this configuration is not an exact match to UI settings. Review and adjust as necessary.

workflows:
  android-gherkin-workflow:
    name: Android Gherkin Workflow
    max_build_duration: 60
    environment:
      vars:
        GCLOUD_KEY_FILE: Encrypted(Z0FBQUFBQmhIS3BIczJmTnpQczlFRWtoc1pXM0w1MkV6T3JfdTQwMElJZkdRQWJXbWI1V1phdWVISUVaeVVUYTkzOGFWeXNreXFhYmZfUWxZd1ljMnZaOVhldml5alo4RnBycGp2SzhPWFhEd0NOWHhQNVdWZnlrbWZyZDJLMmRvU1oyTlFYSEhjbVdkUDRmS2xZY192N3FmWTVzbjhEWlVIU2xzSWZGUWl1WWZCRTg5X2VsRnphS2hVSDBFMjhXdlNfLUJndkVDRnpaVnZXWEVPc3ZaS18tUkQ2SUpwMG1MUHAyZU5aVDI2UHFGb1JOZFJTMjBBX3FGcm9kRWtLRW1XR09XVW8ta2RSZlRRaEZISDNpNHlydmxqRXFSSENQcHZFQmhlNEdLa3A1dFF3MHVWNTZKT09VRm9ZZU90U2lpTW94VkdUcVJRdFNmb1J6cnBVdmJmdkFpelZOYmdadFltTUhpVFRsQ3duR21DWlVYdkVIdHQ0WVdwdWd1N2xOOU9aa0lVU2wxSGEyT0tRVzVDMTl3TWJFcHUzYjA3aDZMUFMtNWZRUXhHTEc1X243SEYzcHFoNU16WUx3MS03bUdhb0RienAwTXQwYXBJUTB6QUNjZWNzMkdFY0l3S2ZYWldyb19DOENwVnY4LXU3RDYtT2NBRWtCclJxdW56OE5ZczZNYkhIVnlScS1yZnBHa1hmeVNlcE9pWnVBVHd3ODEtdlV3cXBGb045aFBlY3NjSTlYNk9xczVzVFVKOEhuWklDSXpUT2RvLWNucDVXYzUyd1V5RjRta2xaSTI2LTRSckp2b2lubjNBWGJGU0pzLVk5c3RYSnlNM0xyaVRWYXJ4NUIyQmxKeVhERGtwRUZpODNXLWJ0QUl2OWNBXzlqV01aaDNRZUp3OUlzaUprWk91QUpLZHZQcm1YWGhMaUZIUWdEY2FDcTAyb09tMmlFY01vaHdfWW1Xb1BuSS1qak1wZlZ1ZWMxSzZrd0RIZ3FIcjdqU0ZwcUVFYV9yZDFzdEJ2OFZEd0ZBbnc1NV9vWFRKRDVXaG9BWjhPanVJNlBmNUdCYl96Z2MxcUt3cGxrSTlXVF80RUVySlVGMlV6NkdUSW9POGNjRnd0R0pwcmRjbjUxYzM3cTNMcFd2RGMyalU4S09uWEhpWE5sVWx3c3BRS0gxdUtqM0ZzdVFwYTRvUXRzOXF6WE51NG9ta2N1NHV3c3JmeEl6VkVFX0RWNU1Qd3FYY3M1SkZSSG5NTm1qeURiOFcyZlE2SFh1T2dtWDV6N1lFdW5XUTkxS2EzVVRYbXE2cUtVTEQxRUVJRk10TTlXd00tWUZyZWREMWJYb0VGUjBnTWRBT25DRG8xcGtoMU5pUU9JdGdDVmEzdXVxWlBneklaVjhDR05EaTVtWFNwLU5ZcWY5RXl6MnI5VE9tQk9KVk1yUXVpSUJBUmR4NFN5TVp1SXZIcExjOWJRQTB0eUo1S2JUTVJBbXNmR2ZqeW5McU5xdEEzMTVzdkNfN2dLdElDQ3lLZ2xzNnBkUzZreWREdkh2YVNmd1ZsN2ZUM0dHalRJcXkxTWp6YkV1U2E4WlRRUG8xQkNDNEhvT1F3RVVkZGFxelZxblF6QVlGTlJJcVlKOEM4NEVEOWRqbjQxNFl0ZjZONUpvX3R6NWpDUlctbGNvMTJiekZ4UmdZRjlnWGotdU90eFBaX1ZUOTdlU2s2UWpvY3BBNWJudFZCVUg2MW9pdzJGUFRkdVI0MmVKMW5HMndudWxlMHhSd0pFWkpuc0t4VE14M1BTeDFXbXNTZm16eF9VcTRHNkRvNjJvaUx4WjhPakJQQmEyVjAxUk9aZVlCMjRMYU1sdmpDWmdRUjByNUg0RGZ4bGE2NThySEEtUTRHdmJ0bHdyMHJGY1hCcEhySnd0NXlieHE5eTdwdkx3Q2lHa2tCZ2V5aDZYQjc5X1p1cWN1bHFFM0NaQzI3Y1A4LUxKTjhwdFdnRXlWcWI4dzFRZHB4dEt4bm5fd0lEZkRDR1oxLWdhR2llRVhLdWlqMXBBVl83bG9seDc4WENTMk9QcUhjbzZZNEZQcVA2S1hHbDU2aDJ0VTJyV2hqc2RTOUdJN2ZDd25Nc0xpVUxkX2l3cFNfNDFRbjFCWmtFb3dxTWozdWpjdzRZWTFSbUlHNDJTSlVMRHVScjIyVjlDYjlxWnNydXRTc0lMYmE0U0YxNDZMZjNUVi1XMVJGZWc3X2dNbGhDcEJyTTNPUExtRmJ6cElaMG5zZDZfXzlZODhZWlZlTzItbnh0cVV4Y1NPWDRWMmJ6aTU4TTFmcWMxUlNRV3dxbEF1RmcwMjQybW1nV1ZpRUNXeGlFOTdrazMtWjBoQndlOEx3WUp0X1RIX3BtSkFVd0U4LUZJOWNuTGtBR3ZUMDZWbnphcFl5U0psNjdSVGUzcDE3TWgxZ0NteURXMl9uM3lXZmduWExWQWtpSWs4ZGxabDNNXzl3RUpydnBET0lfVzAwOHU5WVplYVdxT01pV3ZONlVZbDVhMEJheGNtSTh4MDhsU1lRM29HdDAxNTE5YnNnMWNkcGZPSlhBS1BZVF9UaTk2b3dpR3pFNkpqYVkyaEpyMlJOWDBlbjlkR055cWdGbl9zeV9iRFVzYTdrVW9oTXRCdFlEbmJXZGlWYTI3RnlxbGpxRlg1Z3FoVEhPLU1KcVVJRElJNzdNSmF1ajdOQjZuRDctaExveUFXb09tWE9fWWdOcDJoU1J4Y29vaWtQTUdteWpTQ25kWGdRSlM4UVA1d0hHV1d1ZWxfaWFnRHNNQ252cnZkVGRINWkxa09WR24tdWpxaXdfZHlSN0tQdmZ1R1AzRWJmbXd2RFg2ZlR1X1pqRHV3TjdxaG8zZWIwNHJMX2pscUtGTkFYUzN4bnlJaTNWZlFLOVNBbkxJb0diZ3pTUmRhLS0yRGpfc3J0bW5VTEYtbTZtaUlnS0tuVnpHUE02NExCQU9qbFhxMUYwLTEzZzh0bEVSZGVQZVVlV2NvZjVtUzkyREthRk41M2UydVdTZkE0Vks0MDVNYVgyQzRCZXE0bTBxSS1vbldRVXhlWk1XUlU1NzdDbWx5NXVYcmU5WlBFVmh5ZGdVYUZFaFhWS3d0SGJ6cGFFSEtYaVB2NXBWa2prY0F2MkdrNjU2M3VtdzUxMWFJSlNXWmZVTjlEVkZxSGJQSVUwcnpXSVVRY3VOeHVya3A3cjJMSDdtRjJGdTc1U3NLRTdyNjlnRV8wdzBxX3RkeFRFb1d0S05hSENxM05lWmlnbVBnSmJQMzJaZWV4dE9QZl9hYjJzdUs2YVczXzRrWnVHVUI5WnV2bWRLUnJjbXNFWVN5TWRuSEdESFJzUldyazVMbzMwV0MzTlV4d0JUcmdxaEdtcnVpYVJocUFFUEgzNlBuZ3RQNTE1R1Z0dG05aDBWYnpBSmpmNVI1bUdRS3k1bjktTjJYS0twQkpfQXJsYWVpU2RWNjZJMGFnY1pkVWF4b1p5M0hVWjRsLWVkbU5jOVN0aWEzbVQ3SFpNalktaVd2RC1TdkI5WTZjY1ZZTmx2Ump1YmxDT08wemQ5TlhHeFFqUk5CX0ZFYzdkOEIwN05tVnNzNmprSjF1aGRCdGZCMjlNUVN3YVNaczdNeFdMX05MckVIT2xsRnM2NlZjci1iQ3E2MzlreDYtMmF0Y0dkVndMWXJBZVpTMUtUelhVNHdMbm9PMXVJVTZ3Y1Q5US1UWUY5bDZpWWJ6amRlNURab3NiZWpPbzE0LUVLd2JJcVM1T2R5eHZwb3V4N0JPZzliNm15SklJdlZiVHJieUJJOERjcXE5Mmt0YTFlVHdhbFpEQmljM0hKYUhIOVJiYjM5dlhITkdzRDJoS2tjQ0pnYmFsU0J3cGdOUDdMWTkyRWtWcGRrcnBpazRQcnpGRHFOcmFJckExdENMa3FPX1NDR3dnRVpWcF9VT21OYTNOOUU1YjBvc0ExekpnRnJJUHkwQWFieXRfTjZLbnFtaU1fb20yVlNQSExNQVJaN09aTmRUVk4tbnctNk96NnZsOGZPUmpmUkVHMzFTQmVkYUxOZ19tei1JMFF5dzQ4NGxuSG40X2MwZGNFOUtYVnNLcGVGOUN4VFlGTWZ4VHFuLUNBTVZlWVl4WXpmRWlzV2Zla3lxZENLYUd2Y21BX0hEdkxKMHh0UFBLeVh3aEpxVzg3RkNQZ0l4S1lTSVhPN3dGYm5XVjRKdTkzcndIblItTmFfc19YT2taNkl2R29IdWFIdi1PSnpsMVlKbVgxc3ZOaXRvSkxFcG1ZcHhPbUtwamJmV0RlVEdaVF9nOUNtYkRoYnl1Zmd3VDdyRWFJWnhCT2RqTlFzNUpvQzlOU2c1RTY0RnFTMzh4ZmNvXzJrTURuTnNwbm5wV1pheUhROEMtWUY4NnZPNXdQc3pxc0l4dDRpTGtMNUZfdmhTcGtwSlZ0eGtycjRqcmYwdVA3aUtsTWwzbG5DcHZnM3dObDJuWEMtUlFkVldhcUttQk5sRnVhal9abFRBbmRablJwTGE2bGlqNXA5NzFNeEt4ODVydXZFbGs1d2kzbFVuVVBLUGU1aUs4OEJ5cldlUVFhX2ZQWk9TVmhXdDktd0hUdmRrQW85ME42YWFtbGpvQU9QaHVSdGNqZ0k2UkpyT1dzVWZxUUdOWnAtd01NeHpvVTU0OUl6eDZFSkZ6QjBpWWVhV3M3M3BrWGI1U0pEVEZYQVdzRlRpQlFYdkh5ZjNJX3NJQ3R5Mkc1bWszQ3dDdEZoNTlzb0h5UFBHdkJNQ0trNlJCWjhraUFaX3Foamk2S0R0LS1OYkZrU3lNYWx2U0FIOVhJRUhjdk1ja3lOSHVIVUMtT0RNd1VVR25pdkpPbVZTUWI5aGoyV2k4Vk9lQW9HQnBFZjJJbUtIRzlCUDZUUkFJc3JadUFwTWVjUVZSdDBnRno3X2tWdWFvdURZRFE0MXFjMGpfc3YtZTduUEZLcm5iTGhRenN2SkU1bWtzNURfcW9QTUlwS0ltb2pkUjVNSFF4RDItRVQzTTVWcHVjd3NKQTdkcXEzdmphcmNuNWhpX0FidVNGSklSa3JvM2RXMEttaTFuSjdob1ozLWY3UGszajVfYkZSbzY4WVJjLVpkNjhJVGVUR0M1UUp5TWlpMHVUUVd1S0s4VEw2WEJ5dTB2amg4d3VYNHFsNVRkWjNtLUxaRXB6VnAzY0t1V3BvenVxb0lxRGRwS1U0V19aRDZZdUVVM3JyT3JjbjJ3SFVzVkhmTkpHZ1dnbHlvTTNVTEd1LWxPOGFJSDlaMEs2TU5VdVJYMVJTcjA5V2hYSk03R1liZFVsYml5cHBwQzF6SEp2ZUNGWWJVV3JCaFc4TjVtYURsMGt5cy1iTjBvTThDRjJrWF9wOVhhTkJ6d3JIRVcxcU1NRHZmSEpyOUJ1UW5iTTNvS2Utdjk2aW5oU3NoaEFHSkZVc2ptTGdxUzNtSG81TGdPX0Q1TlBoa0FqQUJUbnBlTFVDOFFQQVVJQlJEQzc1MUlSaDRwRXZRRlBJUlR2bjU4YUMtcV9vQV8teXY1SFBKRzZHZ205TnYxNTA2VTU5eGFUSHllanlLNWRvcUUwbkZuaWZPTU16NndQVWtIVDJTSFdWaUl1SDhhNjhHWktnb1BlVmdCdjE0VFhzNDM4ZGdBMUU2Y3UxbjFZeERJSE9nS09HODJ4U1IybGVuSE5yVFVMZDFDVXBXSU9zZ3pjUGYzaDJiX2RyRkFoeHdDTFVUVnk1dG14clk4bW13azhxT1FHaGM9)
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - |
        # set up debug keystore
        rm -f ~/.android/debug.keystore
        keytool -genkeypair \
          -alias androiddebugkey \
          -keypass android \
          -keystore ~/.android/debug.keystore \
          -storepass android \
          -dname 'CN=Android Debug,O=Android,C=US' \
          -keyalg 'RSA' \
          -keysize 2048 \
          -validity 10000
      - |
        # set up local properties
        echo "flutter.sdk=$HOME/programs/flutter" > "$FCI_BUILD_DIR/android/local.properties"
      - flutter packages pub get
      - flutter build apk --debug
      - |
        cd $FCI_BUILD_DIR

        pushd android
        ./gradlew app:assembleAndroidTest
        ./gradlew app:assembleDebug -Ptarget="$FCI_BUILD_DIR/integration_test/gherkin_suite_test.dart"
        popd

        echo $GCLOUD_KEY_FILE | base64 --decode > ./gcloud_key_file.json

        gcloud auth activate-service-account --key-file=gcloud_key_file.json

        gcloud --quiet config set project watchapptest-582021

        gcloud firebase test android run \
          --type instrumentation \
          --app build/app/outputs/apk/debug/app-debug.apk \
          --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
          --timeout 2m
    artifacts:
      - build/**/outputs/apk/**/*.apk
      - build/**/outputs/bundle/**/*.aab
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - umang.divyanshu@aricent.com
          - siddharth.rath@aricent.com